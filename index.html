<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lesson 8 — Traditional Pop in the 1940s and 50s</title>
<style>
  :root{--bg:#0e0f12;--ink:#e8ebf0;--muted:#b6bdc9;--card:#161821;--line:#262a35;--brand:#59d0ff;--accent:#ffd166}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 'Segoe UI',system-ui,Roboto,sans-serif}
  body.modal-open{overflow:hidden}
  header.top, #main-content, #qna-fab {display: none;}
  .app{max-width:980px;margin:0 auto;padding:1rem}
  .slide{display:none;background:var(--card);border:1px solid var(--line);border-radius:.6rem;padding:1rem;margin:1rem 0}
  .slide:first-of-type{display:block}
  .slide-head{display:flex;align-items:baseline;justify-content:space-between;gap:.75rem;border-bottom:1px solid var(--line);padding-bottom:.4rem;margin-bottom:.6rem}
  .slide h2{margin:.2rem 0;font-size:1.4rem}
  .meter{color:var(--muted);font-size:.9rem}
  .bullets{margin:.6rem 0 1rem 1.1rem}
  .bullets li{margin:.35rem 0}
  .read-btn,.nav-btn,.home-btn,.grade-btn{background:linear-gradient(90deg,var(--brand),#86e3ff);color:#08121f;border:0;font-weight:700;padding:.5rem .85rem;border-radius:.45rem;cursor:pointer}
  .read-btn{background:#233046;color:var(--ink);border:1px solid var(--line)}
  .full{margin:.75rem 0 .5rem 0;line-height:1.75;color:#d9e1ee}
  .deep-list{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin:1rem 0;list-style:none;padding:0}
  .deep-item{width:100%;display:flex;justify-content:center}
  .profile-btn{background:linear-gradient(90deg,var(--accent),#ffe08a);color:#08121f;border:0;font-weight:800;padding:.55rem 1rem;border-radius:.55rem;cursor:pointer;min-width:min(520px,90%);text-align:center}
  .slide-nav{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-top:1rem;gap:.5rem}
  .home-btn{justify-self:center;background:#334055;color:var(--ink);border:1px solid var(--line)}
  .quiz-battle-container{display:flex;gap:1.5rem;align-items:flex-start}
  .quiz-main{flex:1 1 60%}
  .leaderboard{flex:1 1 35%;background:#131622;border-radius:.45rem;padding:1rem;border:1px solid var(--line)}
  .leaderboard-list li{display:flex;justify-content:space-between;padding:.4rem 0;border-bottom:1px solid var(--line);align-items:center}
  .leaderboard-list li:last-child{border-bottom:0}
  .choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.35rem;margin-top:.35rem}
  .choice-btn{display:flex;gap:.5rem;align-items:center;padding:.35rem .5rem;border-radius:.35rem;background:#131622;border:1px solid var(--line);color:var(--ink);font-size:1rem;width:100%;text-align:left;cursor:pointer}
  .interactive-section{margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--line)}
  .interactive-section h3{color:var(--accent);margin-bottom:1rem}
  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.85);z-index:10002;color:var(--ink)}
  .overlay.hidden{display:none}
  .overlay-card{background:var(--card);padding:2rem;border-radius:.75rem;width:min(400px, 90%);text-align:center}
  .overlay-card h3{margin-top:0;font-size:1.5rem;color:var(--accent)}
  .overlay-card input{width:100%;box-sizing:border-box;margin-bottom:1rem;text-align:center}
  .overlay-card button{width:100%;margin-bottom:.5rem}
</style>
</head>
<body>
  <header class="top" id="main-header">
    <div class="app brand">
      <h1>Lesson 8: Traditional Pop in the 1940s and 50s</h1>
      <small>Use Next/Previous or ← → keys. Session ID: <b id="session-id-display"></b></small>
    </div>
  </header>
  <main class="app" id="main-content">
    <div id="slides" class="slides" aria-live="polite"></div>
  </main>
  
  <div id="session-overlay" class="overlay hidden">
    <div class="overlay-card">
      <h3>Join a Session</h3>
      <input type="text" id="session-input" class="content-input" placeholder="ENTER SESSION ID">
      <button id="join-session-btn" class="read-btn" style="background:var(--brand);color:#08121f">Join</button>
      <hr>
      <button id="start-session-btn" class="read-btn" style="background: #06d6a0; color:#08121f">Start a New Session</button>
    </div>
  </div>

  <div id="name-entry-overlay" class="overlay hidden">
    <div class="overlay-card">
        <h3>Welcome!</h3>
        <p>Please enter your name to join the session.</p>
        <input type="text" id="name-input" class="content-input" placeholder="Your Name or Nickname" required>
        <button id="join-btn" class="add-content-btn">Join</button>
        <a href="#" id="join-anonymously" style="color: var(--muted); font-size: 0.9em; display:block; margin-top: .5rem">or join anonymously</a>
    </div>
  </div>

<script type="module">
  // --- IMPORTS AND CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyDxpDj0axohHIFfRQ53NLWBQbf_yI2lJo0",
    authDomain: "interactive-lecture-app.firebaseapp.com",
    projectId: "interactive-lecture-app",
    storageBucket: "interactive-lecture-app.firebasestorage.app",
    messagingSenderId: "47230608512",
    appId: "1:47230608512:web:ba649a4a9ba16cef1df265",
    measurementId: "G-NDLP7MWFH9"
  };
  const appId = 'default-app-id';

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // --- LOCAL STATE (Do not modify) ---
  let userId = null;
  let userName = null;
  let sessionId = null;
  let sessionDataPath = null;
  let isPresenter = false; 
  let ix = 0; 
  let slidesEls;
  
  // ==================================================================
  // --- LESSON CONTENT ---
  // ==================================================================
  
  const SLIDES = [
    {
        "id": "8.00a",
        "title": "Lesson 8: Traditional Pop in the 1940s and 50s",
        "bullets": [],
        "full": `<img src='https://i.imgur.com/0RLPf1d.png' alt='Traditional Pop collage' style='width:100%; border-radius: .4rem;'/>`,
        "deep": []
    },
    {
        "id": "8.00b",
        "title": "Chapter Synopsis Video",
        "bullets": ["Watch this short video for an overview of this chapter's content."],
        "full": `<div style='position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%;'><iframe src='https://player.vimeo.com/video/762001186?autoplay=1' style='position: absolute; top: 0; left: 0; width: 100%; height: 100%;' frameborder='0' allow='autoplay; fullscreen' allowfullscreen></iframe></div>`,
        "deep": []
    },
    {
        "id": "8.01",
        "title": "8.01 Introduction",
        "bullets": [
            "Traditional pop songs began to take shape in the 1920s as stage musical composers grew more popular than Tin Pan Alley songwriters.",
            "These songs were characterized by genteel language, memorable melodies, and harmonies suitable for various arrangements.",
            "A single popular tune, like Hoagy Carmichael's \"Stardust,\" could become a valuable copyrighted merchandise, earning millions.",
            "During the 1930s, solo singers, many of whom started with big bands like Duke Ellington's and Benny Goodman's, became increasingly important and eventually became star attractions.",
            "Many singers in the 1940s and early 1950s began their careers singing with a big band before branching out on their own.",
            "These performers were typically singers, not songwriters, who performed their own interpretations of standard repertory from composers like the Gershwins and Cole Porter."
        ],
        "full": `In the 1940s and 1950s, a specific style of pop music dominated the mainstream. Originating from the stage musicals of the 1920s, these songs were known for their refined lyrics and unforgettable melodies. This created a high demand for new, artistic pop songs for singers, dance bands, movies, and radio shows. As audiences fell in love with the vocalists featured in big bands, singers like Ella Fitzgerald and Bing Crosby became the main attractions, building entire careers on their unique interpretations of popular songs. The singers of this era were celebrated for their performance and interpretation, rather than for writing their own music, and they represent the heart of popular music during the World War II era.`,
        "deep": [
            {
                "title": "The Sound of an Era",
                "summary": "A typical scene from the era of traditional pop.",
                "image": "https://i.imgur.com/nhDA8cG.jpeg",
                "modalHTML": `<p>The image captures the aesthetic of the time, with performers in formal attire, often in a nightclub or theater setting, which was the primary venue for these stars.</p>`
            }
        ]
    },
    {
        "id": "8.02",
        "title": "8.02 Louis Armstrong",
        "bullets": [
            "Louis Armstrong was a beloved pop singer and respected jazz musician with a career spanning fifty years.",
            "Known for his raspy voice, he recorded instrumental music early in his career before frequently singing pop standards with big bands in the 1930s.",
            "Armstrong was the first of the jazz \"scat\" singers, known for singing improvised phrases on neutral syllables.",
            "His duets with Ella Fitzgerald are particularly famous, and in many songs, he would both play his trumpet and sing."
        ],
        "full": `Louis Armstrong stands as one of the most cherished figures in 20th-century music, admired equally as a groundbreaking jazz trumpeter and a uniquely voiced singer. His fifty-year career was marked by his endearing, raspy voice. While his early work with ensembles like the Hot Five and Hot Seven focused on instrumental jazz, by the 1930s he was a frequent vocal collaborator with big bands. Armstrong pioneered jazz "scat" singing and often showcased both his vocal and trumpet talents in the same performance.`,
        "deep": [
            {
                "title": "Louis Armstrong (1901-1971)",
                "image": "https://i.imgur.com/mNLbQsL.jpeg",
                "modalHTML": `<p>"My whole life, my whole soul, my whole spirit is to blow that horn."</p><iframe data-testid="embed-iframe" style="border-radius:12px; margin-top: 1rem;" src="https://open.spotify.com/embed/track/094P9Go47bQKJ5Do15lt69?utm_source=generator" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`,
                "media": [
                    {"label": "Listen: 'Dream a Little Dream of Me'", "href": "https://www.youtube.com/watch?v=ajwI2S2_L2U"}
                ]
            }
        ]
    },
    {
        "id": "8.03",
        "title": "8.03 Frank Sinatra",
        "bullets": [
            "Frank Sinatra began his career singing in amateur shows before being hired by bandleader Harry James and then joining Tommy Dorsey's band in 1940 as a soloist.",
            "His good looks earned him the nickname 'Ol’ Blue Eyes', and he quickly became Dorsey's most popular attraction before going solo.",
            "Sinatra's popularity with young audiences was immense; at a 1943 show, fans cheered him wildly and largely ignored the Benny Goodman band.",
            "A performance on Columbus Day in 1944 caused a riot in Times Square, as tens of thousands of young fans, mostly girls, crowded the area, requiring a massive police response.",
            "Journalists, who had called Bing Crosby a \"crooner,\" coined the new term \"swooner\" for Sinatra to describe his effect on audiences.",
            "By the mid-1940s, he was the undisputed king of pop vocalists, with major record and movie contracts, and was voted America's best pop vocalist over Bing Crosby.",
            "He made the singer, rather than the band, the main attraction, paving the way for future stars like Elvis Presley."
        ],
        "full": `Frank Sinatra's career trajectory redefined the role of a vocalist in popular music. Starting with big bands led by Harry James and Tommy Dorsey, Sinatra's smooth phrasing and charm quickly made him a star attraction. His solo career ignited a level of fan hysteria previously unseen. A 1944 performance at the Paramount Theater resulted in the 'Columbus Day Riot,' where thousands of teenage girls, or 'bobby-soxers,' overran Times Square. This phenomenon led journalists to label him a 'swooner,' a step beyond the 'crooner' title given to his predecessor, Bing Crosby. By the mid-40s, Sinatra had become the top pop vocalist, shifting the focus from the band to the solo singer and becoming one of America's first true pop sex symbols.`,
        "deep": [
            {
                "title": "Frank Sinatra (1915-1998)",
                "image": "https://i.imgur.com/UGezMJg.jpeg",
                "modalHTML": `<p>Acclaimed as both a singer and an actor, Frank Sinatra is the most important link between Tin Pan Alley and the rise of rock and roll. Born in Hoboken, New Jersey to Italian immigrants, he began his career as a big band singer. In the 1950s Sinatra proved that he was also a talented actor, winning an Oscar for Best Supporting Actor in *From Here to Eternity* (1953). Later in life he continued to enjoy success with his 1993 album *Duets* and the Grammy award winning *Duets II* (1994).</p><p><i>"When I sing, I believe. I'm honest... You have to reach out to them with total honesty and humility."</i></p>`,
                "bullets": [
                    "Began with Harry James (1939) and Tommy Dorsey (1940-1942) bands.",
                    "Went solo in 1943, becoming one of the first sex symbols in American pop.",
                    "Won an Academy Award for acting in 1953.",
                    "Memorable recordings include “I Get A Kick Out of You” (1954) and “I’ve Got You Under My Skin” (1956)."
                ],
                "media": [
                    {"label": "Watch: 'I Get A Kick Out of You'", "href": "https://www.youtube.com/embed/wSrHvNr8QQQ"},
                    {"label": "Watch: Video Biography", "href": "https://www.youtube.com/embed/Lm8rZdr7wf8"},
                    {"label": "Read More", "href": "https://www.biography.com/musicians/frank-sinatra"}
                ]
            }
        ]
    },
    {
        "id": "8.04",
        "title": "8.04 Rosemary Clooney",
        "bullets": [
            "Born in Kentucky, Rosemary Clooney started her career at age thirteen singing on the radio with her sister Betty.",
            "After touring with the Tony Pastor big band, she launched a huge solo career.",
            "Her 1951 song \"Come-on-a My House,\" featuring an unusual harpsichord accompaniment, sold over a million copies and made her a star overnight.",
            "She recorded a dozen giant hits, including \"Tenderly,\" \"Hey, There,\" and \"This Ole House.\"",
            "In 1956, *The Rosemary Clooney Television Show* was carried by over one hundred television stations."
        ],
        "full": `Rosemary Clooney's career began at the young age of thirteen on Cincinnati radio. After gaining experience with the Tony Pastor big band, she went solo and achieved massive success. Her 1951 hit "Come-on-a My House" was a breakthrough, selling over a million copies and instantly making her a household name. Her success continued with numerous hit records and her own popular television show in 1956.`,
        "deep": [
            {
                "title": "Rosemary Clooney (1928-2002)",
                "image": "https://i.imgur.com/Cdbh9dJ.jpeg",
                "modalHTML": `<p>A versatile singer and actress, Rosemary Clooney was one of the most popular female vocalists of the 1950s.</p>`,
                "media": [
                    {"label": "Watch: 'Tenderly'", "href": "https://www.youtube.com/embed/CoeYnQHYfkc"}
                ]
            }
        ]
    },
    {
        "id": "8.05",
        "title": "8.05 Tony Bennett",
        "bullets": [
            "Anthony Dominick Bennedetto (Tony Bennett) got his break at age twenty-four on the Arthur Godfrey Talent Scouts Show.",
            "Comedian Bob Hope discovered him, suggested the name change to Tony Bennett, and took him on a national tour.",
            "After the tour, he signed with Mitch Miller at Columbia Records.",
            "His 1962 blockbuster, \"I Left My Heart in San Francisco,\" became his signature song.",
            "Bennett had a long career, collaborating with diverse artists like k.d. lang, Christina Aguilera, and Billy Joel."
        ],
        "full": `Tony Bennett's career began with a successful appearance on a talent show while he was still working as an elevator operator. He was discovered by Bob Hope, who gave him his stage name and took him on tour. This led to a contract with Columbia Records and a string of hits, culminating in his iconic 1962 song, "I Left My Heart in San Francisco." Bennett's career endured for many decades, marked by his timeless style and collaborations with artists from across the musical spectrum.`,
        "deep": [
            {
                "title": "Tony Bennett (1926-2023)",
                "image": "https://i.imgur.com/8Ezom8y.jpeg",
                "media": [
                    {"label": "Watch: 'I Left My Heart in San Francisco'", "href": "https://www.youtube.com/embed/r6DUwMnDxEs"},
                    {"label": "Watch: Short Bio Video", "href": "https://www.youtube.com/embed/Vmay5lba4zU"},
                    {"label": "Watch: Long Bio Video", "href": "https://www.youtube.com/embed/Wbai_IJ0s6s"}
                ]
            }
        ]
    },
    {
        "id": "8.06",
        "title": "8.06 Perry Como",
        "bullets": [
            "Pierino 'Perry' Como worked as a barber before joining Freddie Carlone's band and later the Ted Weems Orchestra in 1937.",
            "After Weems was drafted for WWII, Como signed with Victor Records and had his first hit with \"Goodbye Sue\" (1943).",
            "From 1944 to 1958, Perry Como had 42 songs in the Top Ten charts.",
            "He had his own successful television show for eight years.",
            "His recording of \"Some Enchanted Evening\" from the musical *South Pacific* is a quintessential example of a 1940s/50s pop hit and is in 32-bar song form."
        ],
        "full": `Perry Como's relaxed baritone made him one of the most respected and successful singers of his time. After an early career as a barber and a big band singer, he launched a solo career in 1943 that resulted in an incredible 42 Top Ten hits over 14 years. Beyond his recording success, he was a major television star with his own show for eight years. His version of the Broadway standard "Some Enchanted Evening" exemplifies the lush, romantic pop style that defined the era.`,
        "deep": [
            {
                "title": "Perry Como (1912-2001)",
                "image": "https://i.imgur.com/8VtTqza.jpeg",
                "modalHTML": `<p>One of the most recognizable crooners of the 1940s and 1950s, Perry Como was born to a large Italian-American family in Pennsylvania. He began with a local big band in 1933 and joined Ted Weems’s band in 1936, where his warm baritone voice made him a hit. After the band broke up, Como signed with RCA records in 1943 and had a string of hits. In the 1950s he began a successful career as a television host on *The Kraft Musical Hall* from 1959–1963. He emerged from semi-retirement in 1970 to perform in Las Vegas for the first time in over twenty years, followed by the hit “It’s Impossible.”</p>`,
                "bullets": [
                    "Began touring with a big band in 1933.",
                    "Signed a solo contract with RCA records in 1943.",
                    "Hits included “Till the End of Time” (1945) and “Some Enchanted Evening” (1949).",
                    "Hosted a successful weekly TV variety show from 1959-1963."
                ],
                "media": [
                    {"label": "Watch: 'Some Enchanted Evening'", "href": "https://www.youtube.com/embed/qMq4jSvJJZc"}
                ]
            }
        ]
    },
    {
        "id": "8.07",
        "title": "8.07 Doris Day",
        "bullets": [
            "Doris Day initially wanted to be a dancer, but turned to singing after a car accident broke her leg at age fourteen.",
            "She began her singing career with bandleader Barney Rapp and later worked with the Les Brown band for six years.",
            "She was also a prolific film actress, making 39 movies in her career.",
            "Her song \"Que Sera, Sera (Whatever Will Be, Will Be)\" was featured in the 1956 Alfred Hitchcock film *The Man Who Knew Too Much*, in which she also starred."
        ],
        "full": `Doris Day became a star in both music and film. An aspiring dancer, she pursued singing after a severe leg injury ended her dancing ambitions. She found success as a big band singer, most notably with Les Brown's band, before transitioning to a massive film career in 1948. She starred in 39 movies and her iconic recording of "Que Sera, Sera" was featured in an Alfred Hitchcock thriller she starred in.`,
        "deep": [
            {
                "title": "Doris Day (1922-2019)",
                "image": "https://i.imgur.com/BgJctBF.jpeg",
                "modalHTML": `<p>"When I recorded for Columbia, I could usually do anything in one take...I would invariably want to use the first take because that would be the one that was spontaneous and fresh."</p>`,
                "media": [
                    {"label": "Watch: 'Que Sera, Sera'", "href": "https://www.youtube.com/embed/IKumQCTNJOY"},
                    {"label": "Watch: Bio Video", "href": "https://www.youtube.com/embed/Yd2LsJcFfvE"}
                ]
            }
        ]
    },
    {
        "id": "8.08",
        "title": "8.08 Patti Page",
        "bullets": [
            "Clara Ann Fowler began her career in Tulsa on a radio program called \"Meet Patti Page,\" sponsored by the Page Milk Company, and adopted the name.",
            "She pioneered the recording technique of overdubbing, where she sang duets and four-part harmonies with her own voice.",
            "Following the trend of pop artists covering country songs, she recorded Pee Wee King's \"Tennessee Waltz\" in her overdubbed style.",
            "\"Tennessee Waltz\" became the first song ever to be #1 in every industrialized nation, changing her career and proving the commercial viability of country music.",
            "She was the most successful female recording artist of the 1950s, selling over 60 million records."
        ],
        "full": `Patti Page, born Clara Ann Fowler, became the best-selling female artist of the 1950s through talent and technical innovation. She pioneered the use of overdubbing in pop music, allowing her to create rich harmonies by recording multiple vocal tracks herself. This signature sound was used on her cover of the country song "Tennessee Waltz," which became a massive international hit. The record's success not only launched Page into superstardom but also demonstrated the widespread commercial appeal of country and western music to a mainstream audience.`,
        "deep": [
            {
                "title": "Patti Page (1927-2013)",
                "image": "https://i.imgur.com/bdHbKWO.jpeg",
                "modalHTML": `<p>Patti Page scored hits on both the country and pop charts. Born in Tulsa, Oklahoma, she began singing country songs on local radio as a teenager. She became the first singer to overdub her own voice on her 1947 hit “Confess.” Her string of 1950s hits led to regular appearances on shows like *The Dean Martin Show* and *The Ed Sullivan Show*. By the early 1970s, she shifted her career focus back to country music and continued to perform until 2012.</p>`,
                "bullets": [
                    "Most successful female artist of the 1950s.",
                    "Gained her stage name from a radio show sponsored by the Page Milk Company.",
                    "First hit using overdubbing was “Confess” (1947).",
                    "Scored a massive crossover success with “Tennessee Waltz” (1950)."
                ],
                "media": [
                    {"label": "Watch: 'Tennessee Waltz'", "href": "https://www.youtube.com/embed/iVsJsooSN2Q"},
                    {"label": "Read More", "href": "https://www.hollywoodreporter.com/music/music-news/patti-page-singing-rage-dies-407574/"}
                ]
            }
        ]
    },
    {
        "id": "8.09",
        "title": "8.09 The Boswell Sisters",
        "bullets": [
            "The Boswell Sisters (Connee, Martha, and Helvetia) became a household name singing on a New Orleans radio station.",
            "Their intonation and bluesy harmonies set the model for later female trios.",
            "They were signed by Brunswick Records and backed by the Dorsey Brothers Band on many recordings.",
            "After the group disbanded in 1936, Connee Boswell had a distinguished solo career despite being confined to a wheelchair from childhood polio.",
            "Connee was one of the first female pop singers to alter notes and rhythms in a song, a jazz technique that created a looser feel than was common at the time.",
            "Her paralysis was hidden from the public; in films, she was often placed in a frame under her dress to appear as if she were standing."
        ],
        "full": `The Boswell Sisters were an influential early female vocal trio whose blues-infused harmonies became the blueprint for many groups that followed. After gaining popularity on New Orleans radio, they recorded for Brunswick Records, often with the Dorsey Brothers Band. The group broke up in 1936, but lead singer Connee Boswell launched a successful solo career. Notably, Connee was a vocal innovator, applying jazz-style improvisational changes to pop songs. She achieved this success while concealing her paralysis from polio, a fact that was carefully hidden during her film appearances.`,
        "deep": [
            {
                "title": "Connee Boswell (1907-1976)",
                "image": "https://i.imgur.com/oEQAue5.jpeg",
                "modalHTML": `<p>An important though underrated jazz vocalist, Connee Boswell began her career with her sisters in New Orleans. The Boswell Sisters had a few hits before breaking up in 1935. Connee began her solo career that same year and recorded a string of hits with Bing Crosby. Though she contracted polio at age four, she had a successful performing and film career. Her vocal style was influenced by blues singers like Bessie Smith and she, in turn, was a profound influence on Ella Fitzgerald.</p>`,
                "bullets": [
                    "Group's first hit was “Cryin’ Blues” in 1925.",
                    "Connee recorded solo hits with Bing Crosby.",
                    "Contracted polio at age four but still had a successful film career.",
                    "Cited as a major influence on Ella Fitzgerald."
                ],
                "media": [
                    {"label": "Watch: 'When I Take My Sugar to Tea'", "href": "https://www.youtube.com/embed/Dwb_4WFOFio"},
                    {"label": "Watch: Mini Bio of the Sisters", "href": "https://www.youtube.com/embed/WPboDQWR1Gw"}
                ]
            }
        ]
    },
    {
        "id": "8.10",
        "title": "8.10 The Andrews Sisters",
        "bullets": [
            "The most popular female trio of the 1940s consisted of sisters Patti, Maxine and LaVerne Andrews.",
            "They hit the big time with their recording of \"Bei Mir Bist Du Schön,\" a Yiddish folk song with new lyrics by Sammy Cahn.",
            "They became the favorite vocal group of American military forces during World War II.",
            "Their songs often caught the 'boogie woogie' fever sweeping the nation, such as their hit \"Boogie Woogie Bugle Boy From Company B.\""
        ],
        "full": `The Andrews Sisters were the defining female vocal group of the 1940s. Their breakout hit was an adaptation of a Yiddish folk song, "Bei Mir Bist Du Schön." With their exuberant delivery and smart arrangements, they became immensely popular, appearing in movies and becoming favorites of the Allied forces during WWII. They expertly captured the popular boogie woogie sound in hits like "Boogie Woogie Bugle Boy From Company B."`,
        "deep": [
            {
                "title": "The Andrews Sisters",
                "image": "https://i.imgur.com/vyOOL8x.jpeg",
                "media": [
                    {"label": "Watch: 'Bei Mir Bist Du Schön'", "href": "https://www.youtube.com/embed/bU7mSf5ncbk"},
                    {"label": "Watch: 'Boogie Woogie Bugle Boy'", "href": "https://www.youtube.com/embed/8of3uhG1tCI"}
                ]
            }
        ]
    },
    {
        "id": "8.11",
        "title": "8.11 The Golden Gate Quartet",
        "bullets": [
            "The Golden Gate Quartet was one of the most successful Black groups in the 1930s and 1940s, performing gospel-pop crossover music.",
            "They appeared at John Hammond’s famous \"Spirituals to Swing\" concert at Carnegie Hall in 1938.",
            "Their 1938 version of \"Stormy Weather\" is considered an early example of the musical style that would later be called doo-wop.",
            "Their musical style and stage mannerisms may have been copied by famous Motown groups in the 1960s."
        ],
        "full": `The Golden Gate Quartet was a highly successful Black vocal group from Virginia that blended gospel and pop music. Their prominence was highlighted by an appearance at the legendary "Spirituals to Swing" concert at Carnegie Hall. Musically, they were ahead of their time; their rendition of "Stormy Weather" showcased elements of what would later become known as doo-wop, and their performance style is thought to have influenced later Motown acts.`,
        "deep": [
            {
                "title": "The Golden Gate Quartet",
                "image": "https://i.imgur.com/0dsZ784.jpeg",
                "media": [
                    {"label": "Watch: 'Mockingbird'", "href": "https://www.youtube.com/embed/q4W8Uw00hs8"}
                ]
            }
        ]
    },
    {
        "id": "8.12",
        "title": "8.12 The Ink Spots",
        "bullets": [
            "The Ink Spots were formed in 1934 by Jerry Daniels.",
            "They were not a racially integrated group.",
            "Their signature style featured Bill Kenny singing in a high falsetto, followed by a dramatic recitation from baritone Hoppy Jones.",
            "Their 1939 hit \"If I Didn't Care\" launched them into stardom.",
            "They became a featured attraction at the Apollo Theater and were in such high demand they once rented an ambulance to get through Manhattan traffic for a second show."
        ],
        "full": `The Ink Spots developed one of the most distinctive and influential vocal group styles of the era. It was characterized by a high falsetto lead vocal from Bill Kenny, which was contrasted with a spoken, deep-voiced bridge by Hoppy Jones. This formula propelled their 1939 song "If I Didn't Care" to hit status and made them superstars. The group, which was not racially integrated, became a top draw at venues like the Apollo Theater and were known for their creative solution—renting an ambulance—to navigate city traffic between gigs.`,
        "deep": [
            {
                "title": "The Ink Spots",
                "image": "https://i.imgur.com/sLfbnJd.jpeg",
                "media": [
                    {"label": "Watch: 'If I Didn't Care'", "href": "https://www.youtube.com/embed/YE_qg8JSLk4"},
                    {"label": "Watch: 'We Three'", "href": "https://www.youtube.com/embed/YqsTeLR1aUw"},
                    {"label": "Watch: 'Into Each Life Some Rain Must Fall'", "href": "https://www.youtube.com/embed/PPac8VKU6zc"}
                ]
            }
        ]
    },
    {
        "id": "8.13",
        "title": "8.13 The Hit Parade",
        "bullets": [
            "From 1935 to 1959, the radio show *Your Hit Parade* was the main barometer of a pop song's success.",
            "The show was sponsored by Lucky Strike cigarettes and aired on the CBS network.",
            "It featured a staff of professional singers, including Frank Sinatra and Dinah Shore, who would perform the top ten pop songs each week.",
            "The rankings were based on radio plays, jukebox selections, band performances, and sales of sheet music and records.",
            "The all-time biggest hit on the show was Irving Berlin’s \"White Christmas,\" which appeared 33 times."
        ],
        "full": `*Your Hit Parade* was a highly influential radio show that essentially created the first weekly pop chart. Sponsored by Lucky Strike cigarettes, the show's staff of singers performed the top ten most popular songs in the country. The rankings were determined by a secret formula that calculated a song's popularity across radio, jukeboxes, live performances, and sales. Many of the era's great pop singers performed on the show, and its number one spot was the highest honor for a pop song, achieved most often by Irving Berlin's "White Christmas."`,
        "deep": [
            {
                "title": "More on Your Hit Parade",
                "media": [
                    {"label": "Listen: 'People Will Say We're In Love'", "href": "https://www.youtube.com/embed/VEwVAV3VPw4"},
                    {"label": "Read More", "href": "https://www.radiohalloffame.com/your-hit-parade"}
                ]
            }
        ]
    },
    {
        "id": "8.14",
        "title": "8.14 Conclusion",
        "bullets": [
            "The pop charts of the 1940s and early 1950s were dominated by sweet, sentimental songs performed by star solo singers.",
            "Many of these singers began their careers in big bands before demand led them to go solo.",
            "The landscape of popular music was about to change drastically.",
            "This change was driven by the genre of rhythm and blues, which began crossing over into mainstream pop charts in the 1950s."
        ],
        "full": `The era of the traditional pop singer represented a specific, highly popular style of music that defined the World War II and post-war years. This was a time when the performer's interpretation of a well-crafted song was paramount, and many stars were born from the big band circuit. However, this dominance was not to last. By the 1950s, a new sound, rhythm and blues, began to gain mainstream traction, setting the stage for a revolution that would completely reshape popular music.`,
        "deep": [],
        "wordcloud": true
    }
  ];
  
  const QUIZ = [
    {
        "q": "Critics and journalists called Frank Sinatra a:",
        "choices": ["faker", "enchanter", "swooner", "crooner"],
        "answer": 2
    },
    {
        "q": "Which singer frequently used the technique of overdubbing?",
        "choices": ["Tony Bennett", "Patti Page", "Perry Como", "Rosemary Clooney"],
        "answer": 1
    },
    {
        "q": "Which of the following artists is NOT listed in the text as having sung on the show Your Hit Parade?",
        "choices": ["Perry Como", "Frank Sinatra", "Dorothy Collins", "Johnny Mercer"],
        "answer": 0
    },
    {
        "q": "What year did Frank Sinatra's performance cause a riot in Times Square?",
        "choices": ["1944", "1934", "1954", "1924"],
        "answer": 0
    },
    {
        "q": "Which of these singers was most notable for the scat style of delivery?",
        "choices": ["Ella Fitzgerald", "Louis Armstrong", "Perry Como", "Patti Page"],
        "answer": 1
    },
    {
        "q": "Your Hit Parade was sponsored by:",
        "choices": ["Coca-Cola", "Lucky Strike Cigarettes", "The Apollo Theater", "Columbia Records"],
        "answer": 1
    },
    {
        "q": "Patti Page's hit \"Tennessee Waltz\" was originally:",
        "choices": ["a country and western song", "a Tin Pan Alley tune", "written by Patti Page", "written by Frank Sinatra"],
        "answer": 0
    },
    {
        "q": "How did many popular singers in the 1940s begin their careers?",
        "choices": ["Acting in Hollywood films", "Starring in Broadway musicals", "Singing with a big band", "Attending a conservatory"],
        "answer": 2
    },
    {
        "q": "Which singer was confined to a wheelchair due to contracting polio as a child?",
        "choices": ["Doris Day", "Connee Boswell", "Patti Page", "Rosemary Clooney"],
        "answer": 1
    },
    {
        "q": "The Golden Gate Quartet sang an early version of which musical style?",
        "choices": ["bebop", "gospel", "doo-wop", "soul"],
        "answer": 2
    },
    {
        "q": "True or False: \"Boogie Woogie Bugle Boy of Company B\" was recorded by the Boswell Sisters.",
        "choices": ["True", "False"],
        "answer": 1
    },
    {
        "q": "True or False: The Ink Spots and the Golden Gate Quartet were racially integrated groups.",
        "choices": ["True", "False"],
        "answer": 1
    },
    {
        "q": "True or False: Perry Como and Rosemary Clooney both had their own television shows.",
        "choices": ["True", "False"],
        "answer": 0
    },
    {
        "q": "True or False: Frank Sinatra began his career by singing with Count Basie's orchestra.",
        "choices": ["True", "False"],
        "answer": 1
    },
    {
        "q": "True or False: Doris Day was also a prolific film actress.",
        "choices": ["True", "False"],
        "answer": 0
    },
    {
        "q": "True or False: \"White Christmas\" was the biggest hit of all time on Your Hit Parade.",
        "choices": ["True", "False"],
        "answer": 0
    }
  ];
  
  // ==================================================================
  // --- APPLICATION LOGIC (It is best not to modify below this line) ---
  // ==================================================================

  // --- AUTHENTICATION & INITIALIZATION ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        userId = user.uid;
        checkSessionState();
    } else {
        try {
            await signInAnonymously(auth);
        } catch (error) { console.error("Firebase authentication failed:", error); }
    }
  });

  function initializeInteractiveFeatures(){
    if(!sessionId) return;
    sessionDataPath = `/artifacts/${appId}/public/data/sessions/${sessionId}`;
    setupNavigationListener();
    setupQuizBattleListener();
    setupPollListeners();
    setupWordCloudListener();
    setupQnaListener();
  }
  
  function showApp(){
      document.getElementById('session-overlay').classList.add('hidden');
      document.getElementById('name-entry-overlay').classList.add('hidden');
      document.getElementById('main-header').style.display = 'block';
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('qna-fab').style.display = 'block';
  }

  // --- USER SESSION ---
   function initializeUserSession() {
    const startBtn = document.getElementById('start-session-btn');
    const joinBtn = document.getElementById('join-session-btn');
    
    startBtn.addEventListener('click', () => {
        const newSessionId = Math.floor(100000 + Math.random() * 900000).toString();
        const currentUrl = new URL(window.location.origin + window.location.pathname);
        currentUrl.searchParams.set('session', newSessionId);
        currentUrl.searchParams.set('presenter', 'true');
        window.location.href = currentUrl.href;
    });

    joinBtn.addEventListener('click', () => {
        const sessionInput = document.getElementById('session-input');
        const inputId = sessionInput.value.trim();
        if (inputId) {
            const currentUrl = new URL(window.location.origin + window.location.pathname);
            currentUrl.searchParams.set('session', inputId);
            window.location.href = currentUrl.href;
        }
    });

    const nameInput = document.getElementById('name-input');
    const joinNameBtn = document.getElementById('join-btn');
    const anonBtn = document.getElementById('join-anonymously');

    function joinWithName(name) {
        if (!name || !sessionId) return;
        userName = name;
        localStorage.setItem(`lesson_userName_${sessionId}`, name);
        startApp();
    };
    joinNameBtn.addEventListener('click', () => { if (nameInput.value.trim()) { joinWithName(nameInput.value.trim()); } });
    nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && nameInput.value.trim()) { joinWithName(nameInput.value.trim()); } });
    anonBtn.addEventListener('click', (e) => { e.preventDefault(); joinWithName(`Student${Math.floor(1000 + Math.random() * 9000)}`); });
  }
  
   function checkSessionState() {
    const sessionOverlay = document.getElementById('session-overlay');
    const nameOverlay = document.getElementById('name-entry-overlay');

    const urlParams = new URLSearchParams(window.location.search);
    sessionId = urlParams.get('session');
    isPresenter = urlParams.get('presenter') === 'true';

    if (sessionId) {
        sessionOverlay.classList.add('hidden');
        document.getElementById('session-id-display').textContent = sessionId;
        
        const storedName = localStorage.getItem(`lesson_userName_${sessionId}`);
        if (storedName) {
            userName = storedName;
            startApp();
        } else {
            nameOverlay.classList.remove('hidden');
        }
    } else {
        sessionOverlay.classList.remove('hidden');
    }
}

function startApp() {
    if (!userId || !sessionId || !userName) {
        console.error("Cannot start app, missing user, session, or name info", {userId, sessionId, userName});
        return;
    }
    
    render();

    document.getElementById('session-overlay').classList.add('hidden');
    document.getElementById('name-entry-overlay').classList.add('hidden');
    
    showApp();
    initializeInteractiveFeatures();
}

  // --- INTERACTIVE FEATURES ---
  function setupNavigationListener() {
    const stateRef = doc(db, `${sessionDataPath}/sessionState/state`);
    onSnapshot(stateRef, (docSnap) => {
        const slideState = docSnap.exists() ? docSnap.data() : { currentSlide: 0 };
        const newIndex = slideState.currentSlide ?? 0;
        show(newIndex);
    }, (error) => {
        console.error("[Listener Error] Navigation listener failed:", error);
    });
  }

  // Polls
  function setupPollListeners() {
    document.querySelectorAll('.poll').forEach(pollEl => {
        const pollId = pollEl.dataset.pollId;
        if (pollId) {
            const votesRef = collection(db, `${sessionDataPath}/polls/${pollId}/votes`);
            onSnapshot(query(votesRef), (snapshot) => {
                const votes = {}; let totalVotes = 0; let userVote = -1;
                snapshot.forEach(doc => {
                    const vote = doc.data().choice;
                    votes[vote] = (votes[vote] || 0) + 1;
                    totalVotes++;
                    if (doc.id === userId) userVote = vote;
                });
                renderPollResults(pollId, votes, totalVotes, userVote);
            });
        }
    });
  }

  function renderPollResults(pollId, votes, totalVotes, userVote) {
    const pollEl = document.querySelector(`[data-poll-id="${pollId}"]`);
    if (!pollEl) return;
    pollEl.querySelectorAll('.poll-option').forEach((optionEl, index) => {
        const voteCount = votes[index] || 0;
        const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;
        optionEl.querySelector('.poll-bar').style.width = `${percentage}%`;
        optionEl.querySelector('.poll-percent').textContent = `${Math.round(percentage)}%`;
        const button = optionEl.querySelector('button');
        button.disabled = false;
        optionEl.classList.remove('voted-for');
        if (userVote !== -1) {
            button.disabled = true;
            if (index === userVote) optionEl.classList.add('voted-for');
        }
    });
  }

  async function submitPollVote(pollId, choiceIndex) {
      if (!userId) return;
      const voteRef = doc(db, `${sessionDataPath}/polls/${pollId}/votes/${userId}`);
      await setDoc(voteRef, { choice: choiceIndex });
  };
  
  // Word Cloud
  function setupWordCloudListener() {
    const wordsRef = collection(db, `${sessionDataPath}/wordcloud`);
    onSnapshot(query(wordsRef), (snapshot) => {
        const words = {};
        snapshot.forEach(doc => {
            const word = doc.data().text.toLowerCase().trim();
            words[word] = (words[word] || 0) + 1;
        });
        renderWordCloud(words);
    });
  }

  function renderWordCloud(words) {
    const display = document.getElementById('word-cloud-display');
    if (!display) return;
    display.innerHTML = '';
    const maxFreq = Math.max(...Object.values(words), 1);
    const sortedWords = Object.keys(words).sort((a,b) => words[b] - words[a]);
    sortedWords.forEach(word => {
        const freq = words[word];
        const span = document.createElement('span');
        span.textContent = word;
        const size = 1 + (freq / maxFreq) * 2;
        span.style.fontSize = `${size}em`;
        span.style.opacity = 0.6 + (freq / maxFreq) * 0.4;
        display.appendChild(span);
    });
  }

  async function submitWord() {
    const input = document.getElementById('word-cloud-input');
    const text = input.value.trim();
    if (text && userId) {
        await addDoc(collection(db, `${sessionDataPath}/wordcloud`), { text, author: userId });
        input.value = '';
    }
  };

  // Q&A
  function setupQnaListener() {
    const qnaRef = collection(db, `${sessionDataPath}/qna`);
    onSnapshot(query(qnaRef, orderBy("upvotes", "desc")), (snapshot) => {
        const questions = [];
        snapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));
        renderQna(questions);
    });
  }

  function renderQna(questions) {
    const list = document.getElementById('qna-list');
    if (!list) return;
    list.innerHTML = questions.length ? '' : '<li>No questions yet. Be the first!</li>';
    questions.forEach(q => {
        const hasVoted = localUpvotes.has(q.id);
        const li = document.createElement('li');
        li.innerHTML = `
            <button class="upvote-btn ${hasVoted ? 'voted' : ''}" onclick="upvoteQuestion('${q.id}')" ${hasVoted ? 'disabled' : ''}>
                <span>▲</span>
                <span>${q.upvotes || 0}</span>
            </button>
            <div>
                <p>${q.text}</p>
                <small style="color:var(--muted)">asked by ${q.name || `...${q.author.slice(-4)}`}</small>
            </div>
        `;
        list.appendChild(li);
    });
  }
  
  async function submitQuestion() {
    const input = document.getElementById('qna-input');
    const text = input.value.trim();
    if (text && userId) {
        await addDoc(collection(db, `${sessionDataPath}/qna`), { text, author: userId, upvotes: 0, name: userName || 'Anonymous' });
        input.value = '';
    }
  };

  async function upvoteQuestion(questionId) {
    if (localUpvotes.has(questionId)) return;
    localUpvotes.add(questionId);
    const qRef = doc(db, `${sessionDataPath}/qna/${questionId}`);
    await updateDoc(qRef, { upvotes: increment(1) });
  };
  
  // Quiz Battle
  const BATTLE_QUIZ = QUIZ;
  let localAnswers = {}; 
  let timerInterval = null;

  async function setupQuizBattleListener() {
    const battleStateRef = doc(db, `${sessionDataPath}/quizState/battle`);
    onSnapshot(battleStateRef, (docSnap) => {
      const state = docSnap.exists() ? docSnap.data() : { status: 'waiting', currentQuestion: -1 };
      renderQuizState(state);
    });
    const scoresRef = collection(db, `${sessionDataPath}/scores`);
    onSnapshot(query(scoresRef), (snapshot) => {
      const scores = [];
      snapshot.forEach(doc => scores.push({ id: doc.id, ...doc.data() }));
      scores.sort((a, b) => (b.timePoints || 0) - (a.timePoints || 0) || (b.correctAnswers || 0) - (a.correctAnswers || 0));
      renderLeaderboard(scores);
    });
  }

  function renderLeaderboard(scores) {
      const list = document.getElementById('leaderboard-list');
      if (!list) return;
      list.innerHTML = scores.length ? '' : '<li>No scores yet!</li>';
      scores.forEach(player => {
          list.innerHTML += `<li><div><span class="player-name">${player.name || `Player ...${player.id.slice(-4)}`}</span><span class="correct-answers"> (${player.correctAnswers || 0}/${BATTLE_QUIZ.length})</span></div><span class="score">${player.timePoints || 0} pts</span></li>`;
      });
  }

  function renderQuizState(state) {
    const questionArea = document.getElementById('quiz-question-area'), controlsArea = document.getElementById('quiz-controls'), feedbackArea = document.getElementById('quiz-feedback'), timerArea = document.getElementById('quiz-timer');
    if (!questionArea || !controlsArea || !feedbackArea || !timerArea) return;
    clearInterval(timerInterval);

    if (state.status === 'waiting' || state.currentQuestion === -1) {
      questionArea.innerHTML = '<p>The quiz battle is about to begin!</p>';
      feedbackArea.innerHTML = ''; 
      timerArea.style.display = 'none';
      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Start Quiz Battle</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>Waiting for the presenter to start the quiz...</i></p>`;
      }
    } else if (state.status === 'finished') {
      questionArea.innerHTML = '<h3>Quiz Battle Over!</h3><p>Check the final scores on the leaderboard.</p>';
      feedbackArea.innerHTML = ''; 
      timerArea.style.display = 'none';
      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Play Again?</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>The quiz has ended.</i></p>`;
      }
    } else { 
      timerArea.style.display = 'block';
      const qIndex = state.currentQuestion, question = BATTLE_QUIZ[qIndex];
      const media = question.media ? `<p class="media"><a href="${question.media}" target="_blank" rel="noopener">Open media</a></p>` : '';
      const choices = question.choices.map((opt, ci) => `<button id="choice-${ci}" class="choice-btn" onclick="submitQuizAnswer(${qIndex}, ${ci}, ${state.questionStartTime})">${opt}</button>`).join('');
      questionArea.innerHTML = `<div class="q"><h4>Q${qIndex + 1}. ${question.q}</h4>${media}<div class="choices">${choices}</div></div>`;
      feedbackArea.innerHTML = '';

      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Next Question ▶</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>Waiting for the presenter to advance to the next question...</i></p>`;
      }
      
      const startTime = state.questionStartTime;
      timerInterval = setInterval(() => {
          const elapsedSeconds = (new Date().getTime() - startTime) / 1000;
          if (elapsedSeconds >= 15) {
              timerArea.textContent = '0 points';
              clearInterval(timerInterval);
              if (localAnswers[qIndex] === undefined) {
                  document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                  const correctBtn = document.getElementById(`choice-${question.answer}`);
                  if (correctBtn) correctBtn.classList.add('correct');
                  if (feedbackArea) feedbackArea.textContent = "Time's up!";
              }
          } else {
              timerArea.textContent = `${Math.round(1000 * (1 - (elapsedSeconds / 15)))} points`;
          }
      }, 100);

      if(localAnswers[qIndex] !== undefined) {
          clearInterval(timerInterval);
          showAnswerFeedback(qIndex, localAnswers[qIndex]);
      }
    }
  }

  async function startOrAdvanceQuiz() {
    if (!isPresenter || !userId || !userName) return;
    const battleStateRef = doc(db, `${sessionDataPath}/quizState/battle`);
    const docSnap = await getDoc(battleStateRef);
    const currentState = docSnap.exists() ? docSnap.data() : { status: 'waiting', currentQuestion: -1 };
    let nextQuestion = currentState.currentQuestion + 1;
    if (currentState.status === 'finished' || currentState.status === 'waiting') {
        localAnswers = {};
        const scoresRef = doc(db, `${sessionDataPath}/scores/${userId}`);
        await setDoc(scoresRef, { correctAnswers: 0, timePoints: 0, name: userName || 'Anonymous' });
        nextQuestion = 0;
    }
    if (nextQuestion >= BATTLE_QUIZ.length) {
        await setDoc(battleStateRef, { status: 'finished', currentQuestion: -1 });
    } else {
        await setDoc(battleStateRef, { status: 'in_progress', currentQuestion: nextQuestion, questionStartTime: new Date().getTime() });
    }
  };

  async function submitQuizAnswer(qIndex, choiceIndex, questionStartTime) {
      if (localAnswers[qIndex] !== undefined) return;
      localAnswers[qIndex] = choiceIndex;
      clearInterval(timerInterval);
      const question = BATTLE_QUIZ[qIndex], isCorrect = question.answer === choiceIndex;
      showAnswerFeedback(qIndex, choiceIndex);
      if (isCorrect) {
          const elapsedSeconds = (new Date().getTime() - questionStartTime) / 1000;
          let points = (elapsedSeconds < 15) ? Math.round(1000 * (1 - (elapsedSeconds / 15))) : 0;
          const scoreRef = doc(db, `${sessionDataPath}/scores/${userId}`);
          await setDoc(scoreRef, { correctAnswers: increment(1), timePoints: increment(points) }, { merge: true });
      }
  };

  function showAnswerFeedback(qIndex, choiceIndex) {
      const question = BATTLE_QUIZ[qIndex], isCorrect = question.answer === choiceIndex, feedbackArea = document.getElementById('quiz-feedback');
      document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
      const chosenBtn = document.getElementById(`choice-${choiceIndex}`), correctBtn = document.getElementById(`choice-${question.answer}`);
      if (isCorrect) {
          chosenBtn.classList.add('correct');
          if (feedbackArea) { feedbackArea.textContent = 'Correct!'; feedbackArea.style.color = 'var(--brand)'; }
      } else {
          chosenBtn.classList.add('incorrect');
          correctBtn.classList.add('correct');
          if (feedbackArea) { feedbackArea.textContent = 'Incorrect!'; feedbackArea.style.color = 'rgb(239, 71, 111)';}
      }
  }
  
  // --- RENDERING & DOM MANIPULATION ---
  function toggleProfile(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.hidden = !el.hidden;
  }

  function deepListHTML(sectionIdx, deep){
    if(!deep || !deep.length) return '';
    const items = deep.map((d,di)=>{
      if (d.modalHTML && !d.bullets?.length) {
         const label = `Open content: ${d.title}`;
         return `<li class="deep-item"><button type="button" class="profile-btn" aria-label="${label}" onclick="openProfile(${sectionIdx},${di})">${d.title}</button></li>`;
      }
      const contentId = `profile-content-${sectionIdx}-${di}`;
      const baseBullets = (d.bullets||[]).map(b=>`<li>${b}</li>`).join('');
      const media = (d.media||[]).map(m=>`<li><a href="${m.href}" target="_blank" rel="noopener">${m.label}</a></li>`).join('');
      const extended = d.modalHTML || '';
      const summaryHTML = d.summary?`<p>${d.summary}</p>`:'';
      const bulletsHTML = baseBullets?`<h4>Key points</h4><ul>${baseBullets}</ul>`:'';
      const mediaHTML = media?`<h4>Media</h4><ul class="media">${media}</ul>`:'';
      let fullContentHTML = '';
      if (d.image) {
          fullContentHTML = `<div style="text-align: left;"><div style="display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start; margin-bottom: 1rem;"><div style="flex: 1 1 200px;"><img alt="${d.title}" src="${d.image}" style="width: 100%; height: auto; border-radius: .4rem;"></div><div style="flex: 2 1 300px;">${bulletsHTML}</div></div><div>${summaryHTML}${mediaHTML}${extended}</div></div>`;
      } else {
          fullContentHTML = `<div style="text-align: left;">${summaryHTML}${bulletsHTML}${mediaHTML}${extended}</div>`;
      }
      return `<li class="deep-item" style="flex-direction: column; gap: 0;"><button type="button" class="profile-btn" onclick="toggleProfile('${contentId}')">${d.title}</button><div id="${contentId}" class="full" hidden style="width: min(520px, 90%); max-width: 100%; box-sizing: border-box; padding: 1.2rem; background: #1a1d29; border-radius: 0 0 .55rem .55rem;">${fullContentHTML}</div></li>`;
    }).join('');
    return `<ul class="deep-list">${items}</ul>`;
  }
  
  function pollHTML(check, slideId, isListeningPoll = false) {
    if (!check) return '';
    const pollId = `poll-${slideId}`;
    const choices = check.choices.map((opt, ci) => `<div class="poll-option"><div class="poll-bar"></div><span class="poll-percent">0%</span><button onclick="submitPollVote('${pollId}', ${ci})">${opt}</button></div>`).join('');
    let clipsHTML = '';
    if (isListeningPoll && check.clips) {
      clipsHTML = check.clips.map(clip => `<button class="read-btn" style="margin-right: .5rem;">▶️ ${clip}</button>`).join('');
    }
    return `<div class="poll interactive-section" data-poll-id="${pollId}"><h3>${isListeningPoll ? 'Identify the Technique' : 'Test Your Knowledge'}</h3><p>${check.q}</p>${isListeningPoll ? `<div style="margin-bottom:1rem">${clipsHTML}</div>` : ''}<div class="choices">${choices}</div></div>`;
  }

  function buildABandHTML(data) {
    if (!data) return '';
    const instruments = [...data.correct, ...data.distractors].sort(() => Math.random() - 0.5);
    const instrumentHTML = instruments.map(inst => `<div class="instrument" draggable="true" data-instrument="${inst}">${inst}</div>`).join('');
    return `<div class="interactive-section build-a-band-container"><h3>Build a Group</h3><p>Drag the correct items into the group area.</p><div class="build-a-band"><div class="instrument-pool"><h4>Items</h4>${instrumentHTML}</div><div class="band-area" data-correct='${JSON.stringify(data.correct)}'><h4>Group Area</h4></div></div></div>`;
  }

  function wordCloudHTML() {
    return `<div class="interactive-section word-cloud-container"><div class="word-cloud-input"><h3>Final Thoughts?</h3><p>What one word describes this era of music to you? Add it to our word cloud!</p><div class="content-input-container"><input type="text" id="word-cloud-input" class="content-input" placeholder="e.g., Smooth, Sentimental..."><button class="add-content-btn" onclick="submitWord()">Submit</button></div></div><div id="word-cloud-display" class="word-cloud-display"></div></div>`;
  }

  function render(){
    const host = document.getElementById('slides');
    if (!host) return;
    host.innerHTML = ''; 
    const total = SLIDES.length + 1;

    SLIDES.forEach((s,idx)=>{
      const bullets = s.bullets.map(b=>`<li>${b}</li>`).join('');
      const deep = deepListHTML(idx, s.deep);
      const poll = pollHTML(s.poll, s.id);
      const listeningPoll = pollHTML(s.listening_poll, s.id + '-listen', true);
      const buildaband = buildABandHTML(s.buildaband);
      const wordcloud = s.wordcloud ? wordCloudHTML() : '';
      let footerHTML = '';
      if (isPresenter) {
          const prevBtn = idx > 0 ? `<button class="nav-btn" onclick="go(${idx-1})">◀ Previous</button>` : '<span></span>';
          const nextBtn = (idx < SLIDES.length) ? `<button class="nav-btn" onclick="go(${idx+1})">Next ▶</button>` : '<span></span>';
          footerHTML = `<footer class="slide-nav">${prevBtn}<button class="home-btn" onclick="go(0)">Home</button>${nextBtn}</footer>`;
      }
      host.insertAdjacentHTML('beforeend', `<section class="slide" id="slide-${idx}" data-ix="${idx}" aria-labelledby="h-${s.id}"><header class="slide-head"><h2 id="h-${s.id}">${s.title}</h2><div class="meter">Slide ${idx+1} of ${total}</div></header><ul class="bullets">${bullets}</ul><button class="read-btn" onclick="toggleFull(${idx})">Read Full Text</button><article id="full-${idx}" class="full" hidden>${s.full}</article>${deep}${poll}${listeningPoll}${buildaband}${wordcloud}${footerHTML}</section>`);
    });

    const qIndex = SLIDES.length;
    let quizFooterHTML = '';
    if (isPresenter) {
        quizFooterHTML = `<footer class="slide-nav"><button class="nav-btn" onclick="go(${qIndex-1})">◀ Previous</button><button class="home-btn" onclick="go(0)">Home</button><span></span></footer>`;
    }

    host.insertAdjacentHTML('beforeend', `
      <section class="slide" id="slide-${qIndex}" data-ix="${qIndex}" aria-labelledby="h-quiz">
        <header class="slide-head"><h2 id="h-quiz">Lesson Quiz Battle</h2><div class="meter">Slide ${qIndex + 1} of ${qIndex + 1}</div></header>
        <div class="quiz-battle-container">
          <div class="quiz-main">
            <div id="quiz-timer">1000 points</div>
            <div id="quiz-question-area"><p>Loading Quiz Battle...</p></div>
            <div id="quiz-feedback"></div>
            <div id="quiz-controls"></div>
          </div>
          <div class="leaderboard">
            <h3>Leaderboard</h3>
            <ul id="leaderboard-list">
              <li>Loading...</li>
            </ul>
          </div>
        </div>
        ${quizFooterHTML}
      </section>
    `);
    setupDragAndDrop();
  }

  let lastFocused = null;
  function openProfile(sectionIdx, cardIdx){
    const d = SLIDES[sectionIdx].deep[cardIdx];
    // ... modal logic remains for special cases like videos ...
  }
  function hideModal(){ /* ... modal logic ... */ }
 
  function show(i){ 
    if(!slidesEls) slidesEls = document.getElementsByClassName('slide'); 
    if(i<0||i>=slidesEls.length) return; 
    Array.from(slidesEls).forEach(s=>s.style.display='none'); 
    slidesEls[i].style.display='block'; 
    ix=i; 
    window.scrollTo(0,0); 
  }

  async function go(i){ 
    if (!isPresenter) return;
    const totalSlides = SLIDES.length + 1;
    if (i < 0 || i >= totalSlides) return;
    const stateRef = doc(db, `${sessionDataPath}/sessionState/state`);
    await setDoc(stateRef, { currentSlide: i }, { merge: true });
  }

  function toggleFull(i){ const el=document.getElementById('full-'+i); if(el) el.hidden=!el.hidden; }
  function toggleProfile(elementId) { const el = document.getElementById(elementId); if (el) el.hidden = !el.hidden; }
  
  function setupDragAndDrop() {
    const instruments = document.querySelectorAll('.instrument');
    const dropzone = document.querySelector('.band-area');
    if (!dropzone) return;
    instruments.forEach(inst => {
        inst.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.dataset.instrument));
    });
    const correctInstruments = JSON.parse(dropzone.dataset.correct);
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
    dropzone.addEventListener('drop', e => {
        e.preventDefault();
        dropzone.classList.remove('drag-over');
        const instrumentName = e.dataTransfer.getData('text/plain');
        const instrumentEl = document.querySelector(`[data-instrument="${instrumentName}"]`);
        if (instrumentEl && !dropzone.contains(instrumentEl)) {
            dropzone.appendChild(instrumentEl);
            if (correctInstruments.includes(instrumentName)) instrumentEl.classList.add('correct');
            else instrumentEl.classList.add('incorrect');
        }
    });
  }
  
  document.addEventListener('DOMContentLoaded', ()=>{ initializeUserSession(); });
  
  // --- WINDOW-SCOPED FUNCTIONS FOR HTML ---
  window.go = go;
  window.toggleFull = toggleFull;
  window.openProfile = openProfile;
  window.toggleProfile = toggleProfile;
  window.submitPollVote = submitPollVote;
  window.submitWord = submitWord;
  window.startOrAdvanceQuiz = startOrAdvanceQuiz;
  window.submitQuizAnswer = submitQuizAnswer;
</script>
</body>
</html>
